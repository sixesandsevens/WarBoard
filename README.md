# WarBoard

WarBoard is a lightweight real-time virtual tabletop battlemap.

It provides:
- multi-user WebSocket rooms,
- GM/player permissions,
- token play with ownership/locks/badges,
- drawing and shape layers,
- room snapshots and restore,
- room import/export,
- filesystem token packs,
- persistent room state in SQLite.

## What Is In This Repo

- `server/`: FastAPI app, room/event logic, persistence.
- `static/test_canvas.html`: main canvas client (single-page UI).
- `static/test.html`: minimal/debug WebSocket client.
- `packs/`: optional token pack directories (for token library assets).

## Core Capabilities

### Real-Time Rooms

- Rooms sync over WebSocket: `/ws/{room_id}`.
- Presence is tracked per `client_id`.
- First client with a `gm_key` can claim GM; later GM claims require the same key.
- Room state is broadcast with authoritative server updates.

### Tokens

- Spawn default tokens or drag-spawn from token packs.
- Move permissions:
  - GM can always move.
  - Optional assigned-player movement.
  - Optional everyone-can-move mode.
  - Lockdown and per-token lock enforcement.
- GM actions: rename, resize (`0.25`-`4.0`), assign owner, lock/unlock, delete.
- Token badges: `downed`, `poisoned`, `stunned`, `burning`, `bleeding`, `prone`.
- Labels show on hover/selection with high-contrast text and a readable backdrop.

### Drawing, Shapes, and Layers

- Freehand strokes (`map`, `draw`, `notes` layers).
- Shapes: `rect`, `circle`, `line` (`map`, `draw`, `notes` layers).
- GM can lock/unlock and delete strokes/shapes.
- Eraser is GM-only and can remove strokes and optionally shapes.
- Layer visibility (`grid`, `drawings`, `shapes`, `tokens`) is room-synced.

### Scene and Measurement

- Background modes: `solid`, `url`, `terrain`.
- Terrain styles: `grassland`, `dirt`, `snow`, `desert`.
- Terrain uses deterministic seed generation and can be regenerated by GM.
- Grid settings: size, show/hide, snap, feet-per-square.
- Ruler tool reports distance in squares and feet.

### History, Snapshots, and Persistence

- Undo/redo (GM-only) with a 50-state history window.
- Autosave with debounce (~2 seconds after last change).
- Room snapshots:
  - create labeled checkpoints,
  - restore snapshot (auto-creates a "before restore" checkpoint).
- Room state persists to SQLite in `DATA_DIR/warboard.db`.

## Local Development

### Requirements

- Python 3.10+

Install dependencies:

```bash
pip install -r requirements.txt
```

Run server:

```bash
uvicorn server.app:app --host 0.0.0.0 --port 8000 --reload
```

Open clients:
- Main UI: `http://localhost:8000/static/test_canvas.html`
- Minimal test UI: `http://localhost:8000/static/test.html`

## Configuration

### Data Directory

`DATA_DIR` controls SQLite storage location.

- Default: `./data`
- Example:

```bash
DATA_DIR=/tmp/warboard-data uvicorn server.app:app --reload
```

### Token Packs

- Pack root directory: `./packs`
- Packs are served at: `/packs/<pack_id>/<file>`
- Pack listing endpoint reads `manifest.json` from each pack folder.

Manifest example:

```json
{
  "pack_id": "starter",
  "name": "WarBoard Starter Pack",
  "author": "WarBoard",
  "license": "CC0-1.0",
  "version": "1.0.0",
  "tokens": [
    {
      "id": "goblin_green",
      "name": "Goblin",
      "tags": ["goblin"],
      "file": "images/goblin_green.svg"
    }
  ]
}
```

## Permissions Model

- GM key is provided as `?gm_key=...` in WebSocket/API requests where required.
- Server stores only `gm_key_hash` (SHA-256), never raw key.
- `gm_key_hash` is excluded from outbound `STATE_SYNC`.
- GM-only operations include:
  - room settings updates,
  - undo/redo,
  - token assign/rename/resize/lock/delete/badge toggle,
  - stroke/shape lock/delete,
  - eraser,
  - protected room API operations (rename/delete/export/import/snapshot restore/create).

## HTTP API

### Rooms

- `POST /api/rooms` create room
- `GET /api/rooms` list rooms
- `PATCH /api/rooms/{room_id}` rename room (GM key if configured)
- `DELETE /api/rooms/{room_id}` delete room (fails if active connections)

### Snapshots

- `POST /api/rooms/{room_id}/snapshots` create snapshot
- `GET /api/rooms/{room_id}/snapshots` list snapshots
- `POST /api/rooms/{room_id}/restore/{snapshot_id}` restore snapshot

### Import / Export

- `GET /api/rooms/{room_id}/export` export current room state
- `POST /api/rooms/{room_id}/import` replace room state

### Token Packs

- `GET /api/packs` list available packs
- `GET /api/packs/{pack_id}` fetch pack manifest

## WebSocket Protocol (Overview)

Connect:
- `ws://<host>/ws/{room_id}?client_id=<id>&gm_key=<optional>`

Incoming events include:
- `STATE_SYNC`, `HELLO`, `PRESENCE`, `ROOM_SETTINGS`,
- token events (`TOKEN_CREATE`, `TOKEN_MOVE`, ...),
- drawing/shape events (`STROKE_ADD`, `SHAPE_ADD`, ...),
- `ERROR`, `HEARTBEAT`.

Client sends event envelopes:

```json
{ "type": "EVENT_NAME", "payload": { "...": "..." } }
```

Notes:
- Server applies authorization and validation per event.
- Rejected optimistic token moves are corrected by authoritative `TOKEN_MOVE` responses.
- Basic per-client rate limiting is applied to high-frequency move and erase traffic.

## UI Notes

In `test_canvas`:
- Tools: Move, Pen, Shape, Eraser, Ruler.
- Drawer tabs: Tokens, Rooms, Scene, Players, Settings.
- Hotkeys: `V/P/S/E/R`, `D`, `Tab`, `Delete/Backspace`, `Esc`.

## Known Scope

This is currently a pragmatic single-file frontend plus FastAPI backend architecture focused on speed and simplicity (not a framework-split production monorepo yet).
